<?php

function sport_event_init() {
  drupal_add_css(drupal_get_path('module', 'sport_event') . '/sport_event.css');
}


function sport_event_menu() {

}

/**
 * Implements hook_views_api().
 */
function sport_event_views_api() {
  return array(
  	'version' => '3.0', 
  	'path' =>  drupal_get_path('module', 'sport_event') . '/views', 
  );
}


/**
 *
 * implements hook_block_info()
 */
function sport_event_block_info() {

  $blocks['recent_event_left'] = array('info' => t('Recent Event Images - Left'), );
  $blocks['recent_event_right'] = array('info' => t('Recent Event Images - Right'), );
  $blocks['registration_button'] = array('info' => t('Event Registration Button'), );
  return $blocks;
}

/**
 *
 * implements hook_block_view()
 */
function sport_event_block_view($delta = '') {
  // The $delta parameter tells us which block is being requested.
  $nid = 0;
  switch ($delta) {
    case 'recent_event_left':
      $nid = get_recent_event_id(0, 1);
      return recent_events_block($nid);
    case 'recent_event_right':
      $nid = get_recent_event_id(1, 1);
      return recent_events_block($nid);
    case 'registration_button':
      return registration_button_block();
      break;
  }

}



/**
 *
 * Creates markup for first N promoted products.
 * @param integer $nid - nid of event node
 * @param integer $items - number of images to show
 */
function get_recent_event_images_view($nid, $items) {

  $style_name = 'search_thumbnail';
  // Select first N products associated with event
  $query = new EntityFieldQuery;
  $entities =  $query
  ->entityCondition('entity_type', 'node')
  ->entityCondition('bundle', 'product')
  ->propertyCondition('status', 1)
  ->fieldCondition('field_event_reference', 'nid', $nid, '=')
  ->fieldCondition('field_promote', 'value', TRUE, '=')
  ->range(0, $items)
  ->execute();

  $products = node_load_multiple(array_keys($entities['node']));

  // build makrup for images
  $markup ='<div class="recent-event-images">';
  foreach ($products as $product) {
    // get html for the image style
    $image= $product->uc_product_image['und'][0];
    $image_array = array(
      'style_name' => 'search_thumbnail',
      'path' => $image['uri'],
      'width' => '',
      'height' => '',
      'alt' => $image['alt'],
      'title' => $image['title'],
    );
     
    $markup = $markup . '<div class="recent-event-image" id="thumb-'. $product->nid .'"->';
    $markup = $markup . theme('image_style',$image_array);
    $markup = $markup . '</div>';
  }
  $markup = $markup . '</div>';
  return $markup;
}


/**
 *
 * Builds recent event block for event node id provided
 * @param integer $nid nid of Event
 */
function recent_events_block($nid) {

  $event = node_load($nid);
  $block = array();
  $block['subject'] = check_plain($event->title);

  // get first images for event
  $block['content'][] = array('#markup' => get_recent_event_images_view($nid, 4));
  // add form to search products from same event
  $block['content'][] = drupal_get_form('recent_event_search_form_' . $nid, $nid); ;

  return $block;

}

/**
 *
 * implements hook_forms
 * @param sting $form_id
 */
function photo_search_forms($form_id) {

  $forms = array();
  if (strpos($form_id, 'recent_event_search_form_') === 0) {
    // $nids = array_map('strrev', explode('_', strrev($form_id)));
    $forms[$form_id] = array(
      'callback' => 'recent_event_search_form',
    //   'callback arguments' => array($nids[0]),
    );
  }
  return $forms;

}

/**
 * Builds form for recent events regions
 * @return string
 */
//function recent_event1_image() {
function recent_event_search_form() {

  $form = array();
  $form['runner_number'] =
  array(
  	'#type' => 'textfield',
  	'#title' => 'Runner Number', 
  	'#size' => '20',
  	'#required' => 'true');
  $form['submit_button'] =
  array( // search button
  	'#type' => 'submit', 
  	'#value' => '', 
  	'#submit' => array('recent_event_search_submit'), 
  );

  return  $form;

}

function recent_event_search_validate($form, &$form_state) {

  if ($form['runner_number']['#value']  == 'My Number' || $form['runner_number']['#value']  == '') {
    form_set_error('runner_number', t('Please enter your number'));
  }
}

function registration_button_block() {


  $block = array();
  $block['subject'] = 'Event Registration Button';
  // add form to search products from same event

  $block['content'][] = drupal_get_form('registration_button_form'); ;

  return $block;

}

/**
 *
 * Ajax button implementation for photographer registration at an event
 * @param array $form
 * @param array $form_state
 */
function registration_button_form($form, &$form_state) {
  $nid = -1;

  // get node id for the event
  if(arg(0) == 'node' && is_numeric(arg(1))) {
    $nid = arg(1);
  }
  else { // it is not a node profile page, so don't show the button
    watchdog ('Callback', 'Registration button is visible in a wrong place.', array($form), WATCHDOG_ERROR);
    return;
  }
  
  // check whether photographer is already registered. 
  global $user;   
  $is_registered = sport_event_is_registered_photographer($nid, $user->uid);
  if ($is_registered) { 
    return; // no need to show the button for registered photographer
  }
  
  // define the button with AJAX callback
  $form['submit'] =
  array( // search button
  	'#type' => 'submit', 
  	'#value' => 'I will be there!', 
    '#prefix' => '<div id="registration-button">',
  	'#suffix' => '</div>',
    '#attributes' => array('class' => array('button')),
  	'#submit' => array('event_registration_form_submit'), 
    '#ajax' => array(
      'callback' => 'registration_button_js',
      'wrapper' => 'registration-button',
      'effect' => 'fade',
  ),
  );

  // cache nid in the form as it will not be available in the callback overwise
  $form['nid'] =
  array(
    '#type' => 'hidden',
    '#value' =>  $nid,   
  );
  return $form;
}

function event_registration_form_submit($form, &$form_state) {
  // @todo put code here for graceful degradation if needed (when JavaScript is off on client side)
}

/**
 *
 * Callback function for event registration button
 * @param array $form
 * @param array $form_state
 */
function registration_button_js($form, $form_state) {
  global $user;
  $nid = $form['nid']['#value'];
  // register photographer to the event
  sport_event_register_photographer($nid, $user->uid);
  // replace button with disabled version
  $markup = '<div id="registration-button" class="button disabled">I will be there!</div>';
  // post registration message
  return $markup . '<div id="complete-registration" class="nice-message">'. t('We are looking forward to see your photos!') . '</div>';

}

/**
 * For testing purpose
 * @param type $form
 * @param type $form_state
 */
function recent_event_search_submit($form, &$form_state) {
  // get event id and number
  $eid = $form['event_id']['#value'];
  $number = $form['runner_number']['#value'];
  // build path to the search page
  $path = 'search-result/' . $eid . '/' . $number;
  $form_state['redirect'] =
  array(
  $path,
  array(),    // $options
  302,  // $http_response_code
  );
}

/**
 * impelements hook form_alter
 */
function sport_event_form_alter(&$form, &$form_state, $form_id) {
  /*
   if ($form_id == 'system_cron_settings') {
   $form['cron']['cron_safe_threshold']['#options'] = array(0 => 'Never', '900' => '15 Mins', '1800' => '30 Mins', '3600' => '1 hour', '10800' => '3 hours', '21600' => '6 hours', '43200' => '12 hours', '86400' => '1 day', '604800' => '1 week');
   } */
  // set event id into the hidden field of the form
  // so we could build correct path on submit.
  if (strpos($form_id, 'recent_event_search_form_') === 0) {
    $nid = $form_state['build_info']['args'][0];
    $form['event_id'] = array('#type' => 'hidden', '#value' => $nid, );
  }
}



/**
 * Gets path of the folder in S3 bucket for the style
 * @param string $styleName
 */
function image_style_s3_uri($file, $styleName) {

  if (strpos($file['uri'], 's3://') === 0) {
    return file_create_url('s3://') . 'styles/' . $styleName . '/s3/' . $file['filename'];
  }
  else {
    return image_style_url($style_name, $file['uri']);
  }
   
<<<<<<< HEAD
=======
}

/**
 * Implements hook_views_api().
 */
function sport_event_views_api() {
  return array(
   'version' => '3.0', 
   'path' =>  drupal_get_path('module', 'sport_event') . '/views', 
  );
>>>>>>> 05659f90df69b9b7b6f2703664b9b7b97a6ab237
}