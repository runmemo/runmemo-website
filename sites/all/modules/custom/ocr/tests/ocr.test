<?php

require_once(DRUPAL_ROOT . '/' . drupal_get_path('module', 'ocr') . '/tests/' . 'ocr_test.inc');


class OcrIntegrationTestCase extends DrupalWebTestCase {

  protected $testNode;

  public static function getInfo() {
    return array(
				'name' => 'OCR Integration Test Case',
				'description' => 'Integration tests for OCR functionality.',
				'group' => 'OCR',
    );
  }

  function setUp() {
    parent::setUp('ocr');

    $this->testNode = product_node_creator::getNewProductNode();
  }

  /**
   *
   * Test that product node is updated correclty with data from fake response message
   */
  function testResponceToUpdateProductNode() {
    // get message with OCR Results
    $MessageOcrResponse = sqs_fake::getFakeResponseMessage($this->testNode->nid);
     
    $results_saver = new OcrResultsSaver($MessageOcrResponse);
    $results_saver->Save();

    // load node to check that it has correct values saved to it.
    $node = node_load($this->testNode->nid);

    // check success field
    $ocr_success_on_node = field_get_items('node', $node, 'ocr_success', $node->language);
    $ocr_success_val = $ocr_success_on_node[0]['value'];

    $this->assertEqual(1, $ocr_success_val, 'Ocr Success filed is successfully updated with True value.');

    // check numbers field
    // numbers matching numbers in the file with fake message.
    $numbers = array(4745, 500, 5);
    $setValues = field_get_items('node', $node, 'ocr_numbers', $node->language);
     
    $matches = 0;
    foreach ($setValues as $setValue) {
      if (in_array($setValue['value'], $numbers)) {
        $matches++;
      }
    }
    $this->assertEqual(3, $matches, 'All 3 numbers were added correctly to the node.');
     
  }
}
