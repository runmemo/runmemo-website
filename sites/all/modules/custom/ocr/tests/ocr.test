<?php

require_once(DRUPAL_ROOT . '/' . drupal_get_path('module', 'ocr') . '/tests/' . 'ocr_test.inc');


class OcrIntegrationTestCase extends DrupalWebTestCase {

  protected $testNode;

  public static function getInfo() {
    return array(
				'name' => 'OCR Integration Test Case',
				'description' => 'Integration tests for OCR functionality.',
				'group' => 'OCR',
    );
  }

  function setUp() {
    parent::setUp('ocr');

    $this->testNode = product_node_creator::getNewProductNode();
  }

  /**
   *
   * Test that product node is updated correclty with data from fake response message
   */
  function testResponceToUpdateProductNode() {
    // get message with OCR Results
    $fake = new sqs_fake($this->testNode->nid);
    $MessageOcrResponse = $fake->getFakeMessage('response_message_fake.json');
     
    $results_saver = new OcrResultsSaver($MessageOcrResponse);
    $results_saver->Save();

    // load node to check that it has correct values saved to it.
    $node = node_load($this->testNode->nid);

    // check success field
    $ocr_success_on_node = field_get_items('node', $node, 'ocr_success', $node->language);
    $ocr_success_val = $ocr_success_on_node[0]['value'];

    $this->assertEqual(1, $ocr_success_val, 'Ocr Success filed is successfully updated with True value.');

    // check numbers field
    // numbers matching numbers in the file with fake message.
    $numbers = array(4745, 500, 5);
    $setValues = field_get_items('node', $node, 'ocr_numbers', $node->language);
     
    $matches = 0;
    foreach ($setValues as $setValue) {
      if (in_array($setValue['value'], $numbers)) {
        $matches++;
      }
    }
    $this->assertEqual(3, $matches, 'All 3 numbers were added correctly to the node.');
     
  }
  /**
   * 
   * Tests that watchdog messsage is created for the unsuccessful OCR result.
   */
  function testResponseWithErrorIsSaved() {
  	// get message with OCR Results
  	$fake = new sqs_fake($this->testNode->nid);
    $MessageOcrResponse = $fake->getFakeMessage('response_error_fake.json');
    $results_saver = new OcrResultsSaver($MessageOcrResponse);
    $results_saver->Save();
    
    $sql = 'SELECT w.message FROM {watchdog} w WHERE w.type = :type';
   	$result =  db_query_range($sql,0,5, array(':type' => 'OCR Message Error'));
   	$count_matches = 0;
   	$error = '';
   	foreach ($result as $record)
   	{
   		$error = $record->message;
   		$count_matches++;
   	}
   	
   	$this->assertEqual(1, $count_matches, 'Watchdog message was created for errorred OCR response.');
    $this->assertEqual('Mock error message in OCR responce', $error, 'Error message in the watchdog log matches error from OCR message.');
  }
  
}
